@page "/branch"
@using System.Net.Http.Json
@using HospitalDTO.ResponseModel
@using HospitalDTO.UpdateRequestModel
@using HospitalWeb.Authentication
@using MudBlazor
@using System.Net.Http.Headers
@inject HttpClient httpClient
@inject ISnackbar Snackbar
<MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="Create">Добавить филялы</MudButton>
<br />
<br />
<MudTable Items="@Elements" ReadOnly="@ronly" CanCancelEdit="@canCancelEdit" Filter="new Func<BranchResponse,bool>(FilterFunc)"
          @bind-SelectedItem="selectedItem1" SortLabel="Sort By" CommitEditTooltip="Commit Edit"
          OnCommitEditClick="@(() => Snackbar.Add("Commit Edit Handler Invoked"))" RowEditPreview="BackupItem" RowEditCancel="ResetItemToOriginalValues"
          RowEditCommit="ItemHasBeenCommitted" IsEditRowSwitchingBlocked="@blockSwitch" ApplyButtonPosition="@applyButtonPosition" EditButtonPosition="@editButtonPosition" EditTrigger="@editTrigger">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Руйхати Филялхо</MudText>
        <MudSpacer />
        <MudTextField @bind-Value="searchString" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
    </ToolBarContent>
    <HeaderContent>
        <MudTh><MudTableSortLabel SortBy="new Func<BranchResponse, object>(x=>x.Id)">Nr</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<BranchResponse, object>(x=>x.Name)">Name</MudTableSortLabel></MudTh>
        <MudTh><MudTableSortLabel SortBy="new Func<BranchResponse, object>(x=>x.Location)">Location</MudTableSortLabel></MudTh>
    </HeaderContent>
    <RowTemplate Context="context">
        <MudTd DataLabel="Nr">@((Elements.ToList().IndexOf(context) + 1).ToString())</MudTd>
        <MudTd DataLabel="Name">@context.Name</MudTd>
        <MudTd DataLabel="Location">@context.Location</MudTd>
    </RowTemplate>
    <RowEditingTemplate>
        <MudTd DataLabel="Nr">@((Elements.ToList().IndexOf(context) + 1).ToString())</MudTd>
        <MudTd DataLabel="Name">
            <MudTextField @bind-Value="@context.Name" Required />
        </MudTd>
        <MudTd DataLabel="Hospital Name">
            <MudTextField @bind-Value="@context.HospitalName" Required />
        </MudTd>
        <MudTd DataLabel="Location">
            <MudTextField @bind-Value="@context.Location" Required />
        </MudTd>
    </RowEditingTemplate>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
    <EditButtonContent Context="button">
        <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" Class="pa-0" OnClick="@button.ButtonAction" Disabled="@button.ButtonDisabled" />
    </EditButtonContent>
</MudTable>
<div class="d-flex flex-wrap mt-4">
    <MudSwitch @bind-Checked="@ronly" Color="Color.Tertiary">Read Only</MudSwitch>
    <div class="d-flex justify-start align-center">
        <p class="mud-typography mud-typography-body1 mud-inherit-text mr-2">Form</p>
        <MudSwitch @bind-Checked="@canCancelEdit" Color="Color.Info">Can Cancel Edit</MudSwitch>
    </div>
</div>
@code {
    [Inject]
    private CustomAuthenticationStateProvider authenticationStateProvider { get; set; }

    private string authToken;

    private List<string> editEvents = new();
    private bool ronly = false;
    private bool canCancelEdit = false;
    private bool blockSwitch = false;
    private string searchString = "";
    private BranchResponse selectedItem1 = null;
    private BranchResponse elementBeforeEdit;
    private HashSet<BranchResponse> selectedItems1 = new HashSet<BranchResponse>();
    private TableApplyButtonPosition applyButtonPosition = TableApplyButtonPosition.End;
    private TableEditButtonPosition editButtonPosition = TableEditButtonPosition.End;
    private TableEditTrigger editTrigger = TableEditTrigger.RowClick;
    private IEnumerable<BranchResponse> Elements = new List<BranchResponse>();

    private HospitalUpdateRequest updateRequest;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            authToken = await authenticationStateProvider.GetToken();
            if (authToken != null)
            {
                httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", authToken);
                Elements = await httpClient.GetFromJsonAsync<List<BranchResponse>>("api/Branch");
            }
        }
        catch (Exception)
        {

            throw;
        }
    }
    protected async Task Create()
    {
        _navigationManager.NavigateTo("/addbranch");
    }

    private void AddEditionEvent(string message)
    {
        editEvents.Add(message);
        StateHasChanged();
    }

    private void BackupItem(object element)
    {
        elementBeforeEdit = new()
            {
                Id = ((BranchResponse)element).Id,
                Name = ((BranchResponse)element).Name,
                Location = ((BranchResponse)element).Location
            };
        AddEditionEvent($"Маьлум вакт маьлумотатон сабт шуда меистатд");
    }

    private async void ItemHasBeenCommitted(object element)
    {
        updateRequest = new HospitalUpdateRequest
            {
                Id = ((BranchResponse)element).Id,
                Name = ((BranchResponse)element).Name,
                Location = ((BranchResponse)element).Location
            };
            httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", authToken);
            var result = httpClient.PutAsJsonAsync<HospitalUpdateRequest>("api/Branch", updateRequest);
            AddEditionEvent($"Маьлумоти шумо Иваз карда шуд");
    }

    private void ResetItemToOriginalValues(object element)
    {
        ((BranchResponse)element).Id = elementBeforeEdit.Id;
        ((BranchResponse)element).Name = elementBeforeEdit.Name;
        ((BranchResponse)element).Location = elementBeforeEdit.Location;
        AddEditionEvent($"Амалёт бекор карда шуд");
    }

    private bool FilterFunc(BranchResponse element)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (element.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (element.Location.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if ($"{element.Id} {element.Name} {element.Location}".Contains(searchString))
            return true;
        return false;
    }
}