@page "/hospital"
<MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="Create">Добавить</MudButton>
<br />
<br />
@if (Hospitals !=null)
{
<MudDataGrid T="HospitalResponse" Items="@Hospitals" ReadOnly="@_readOnly" EditMode="@(_isCellEditMode ? DataGridEditMode.Cell : DataGridEditMode.Form)"
                 StartedEditingItem="@StartedEditingItem" CanceledEditingItem="@CanceledEditingItem" CommittedItemChanges="@CommittedItemChanges"
             Bordered="true" Dense="true" EditTrigger="@(_editTriggerRowClick ? DataGridEditTrigger.OnRowClick : DataGridEditTrigger.Manual)">
    <Columns>
        <TemplateColumn>
            <HeaderTemplate>
                <MudText>Номер</MudText>
            </HeaderTemplate>
            <CellTemplate Context="context">
                <MudText>@((Hospitals.ToList().IndexOf(context.Item) + 1).ToString())</MudText>
            </CellTemplate>
        </TemplateColumn>
        <PropertyColumn Property="x => x.Name" Title="Название"/>
        <PropertyColumn Property="x => x.Location" Title="Адресс"/>
        <TemplateColumn Hidden="@(_isCellEditMode || _readOnly || _editTriggerRowClick)" CellClass="d-flex justify-end">
            <CellTemplate>
                <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Edit" OnClick="@context.Actions.StartEditingItemAsync" />
                    <MudIconButton Size="@Size.Small" Icon="@Icons.Material.Outlined.Delete" OnClick="() => ConfirmDelete(context.Item.Id)" />
            </CellTemplate>
        </TemplateColumn>
    </Columns>
        <PagerContent>
            <MudDataGridPager T="HospitalResponse" />
        </PagerContent>
</MudDataGrid>
<div class="d-flex flex-wrap mt-4">
    <MudSwitch @bind-Checked="@_readOnly" Color="Color.Primary">Read Only</MudSwitch>
</div>
}
@code {
    [Inject]
    private CustomAuthenticationStateProvider authenticationStateProvider { get; set; }

    private string authToken;
    private bool _readOnly;
    private bool _isCellEditMode;
    private List<string> _events = new();
    private bool _editTriggerRowClick;

    private HospitalRequest hospitalRequest = new();

    private IEnumerable<HospitalResponse> Hospitals;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            authToken = await authenticationStateProvider.GetToken();
            if (authToken != null)
            {
                _httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", authToken);
                Hospitals = await _httpClient.GetFromJsonAsync<List<HospitalResponse>>("api/Hospital");
            }
        }
        catch (Exception)
        {
            throw;
        }
    }
    protected async Task Create()
    {
        _navigationManager.NavigateTo("/addhospital");
    }

    private async Task ConfirmDelete(Guid id)
    {
        var parameters = new DialogParameters
            {
                ["Message"] = "Вы уверены, что хотите удалить"
            };

        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.ExtraSmall };

        var dialog = DialogService.Show<ConfirmDialog>("Подтверждение", parameters, options);
        var result = await dialog.Result;

        if (!result.Cancelled)
        {
            await Delete(id);
        }
    }
    protected async Task Delete(Guid id)
    {
        try
        {
            _httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", authToken);
            await _httpClient.DeleteAsync($"api/Hospital?id={id}");
            Hospitals = await _httpClient.GetFromJsonAsync<List<HospitalResponse>>("api/Hospital");
        }
        catch (Exception)
        {

            throw;
        }
    }

    // events
    void StartedEditingItem(HospitalResponse item)
    {
        _events.Insert(0, $"Event = StartedEditingItem, Data = {System.Text.Json.JsonSerializer.Serialize(item)}");
    }

    void CanceledEditingItem(HospitalResponse item)
    {
        _events.Insert(0, $"Event = CanceledEditingItem, Data = {System.Text.Json.JsonSerializer.Serialize(item)}");
    }
    private void CommittedItemChanges(HospitalResponse item)
    {
        var updateRequest = new HospitalUpdateRequest
            {
                Id = item.Id,
                Location = item.Location,
                Name = item.Name
            };
        try
        {
            _httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", authToken);
            _httpClient.PutAsJsonAsync<HospitalUpdateRequest>("api/Hospital", updateRequest);
            _events.Insert(0, $"Event = CanceledEditingItem, Data = {System.Text.Json.JsonSerializer.Serialize(item)}");
        }
        catch (Exception)
        {
            throw;
        }
    }
}